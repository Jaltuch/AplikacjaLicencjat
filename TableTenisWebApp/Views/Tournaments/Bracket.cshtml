@model TableTenisWebApp.Models.Tournament

@{
    ViewData["Title"] = "Drabinka turnieju";
    var rounds = Model.Matches
        .GroupBy(m => m.RoundNumber)
        .OrderBy(g => g.Key)
        .ToList();
    string? winnerName = null;

    var lastRound = rounds.LastOrDefault();
    if (lastRound != null && lastRound.Count() == 1)
    {
        var finalMatch = lastRound.First();
        if (finalMatch.IsApproved && finalMatch.Score1 != finalMatch.Score2)
        {
            winnerName = finalMatch.Score1 > finalMatch.Score2
                ? finalMatch.Player1?.ApplicationUser?.FirstName + " " + finalMatch.Player1?.ApplicationUser?.LastName
                : finalMatch.Player2?.ApplicationUser?.FirstName + " " + finalMatch.Player2?.ApplicationUser?.LastName;
        }
    }

    Func<int, string> getRoundLabel = matchCount => matchCount switch
    {
        1 => "🏆 Finał",
        2 => "🥈 Półfinał",
        4 => "🥉 Ćwierćfinał",
        8 => "1/8 finału",
        16 => "1/16 finału",
        32 => "1/32 finału",
        _ => "Runda"
    };
}

<style>
    .bracket-container {
        display: flex;
        gap: 3rem;
        overflow-x: auto;
        padding: 1rem 0;
    }

    .bracket-round {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        min-width: 200px;
        align-items: center;
    }

    .match-card {
        
        background: #ffffff;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        width: 180px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: transform 0.1s, box-shadow 0.1s;
        cursor: pointer;
    }

    .match-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        
    }
    

    .match-player {
        margin-bottom: 0.2rem;
    }

    .winner {
        color: #198754;
        font-weight: bold;
    }

    .round-header {
        font-size: 1.1rem;
        font-weight: 600;
        text-align: center;
    }

    .connector {
        position: absolute;
        top: 50%;
        right: -1.5rem;
        width: 1.5rem;
        height: 2px;
        background: #ccc;
    }
</style>

<h2>Drabinka – @Model.Name</h2>

@if (!string.IsNullOrEmpty(winnerName))
{
    <div class="alert alert-success text-center fs-5 fw-bold mb-4">
        🏆 Zwycięzca turnieju: @winnerName 🏆
    </div>
}

<a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary mb-3">
    <i class="bi bi-box-arrow-left"></i> Szczegóły turnieju
</a>

<div class="bracket-container">
    @foreach (var round in rounds)
    {
        var label = getRoundLabel(round.Count());

        <div class="bracket-round">
            <h5 class="round-header">@label</h5>
            @foreach (var match in round.OrderBy(m => m.DatePlayed))
            {
                <div class="match-card" onclick="location.href='@Url.Action("Details", "Matches", new { id = match.Id })'">
                    @if (match.Player1Id == match.Player2Id)
                    {
                        <div><strong>@(match.Player1?.ApplicationUser?.FirstName) @(match.Player1?.ApplicationUser?.LastName)</strong></div>
                        <div><em>wolny los</em></div>
                    }
                    else
                    {
                        var p1Win = match.Score1 > match.Score2;
                        var p2Win = match.Score2 > match.Score1;

                        <div>
                            <a asp-controller="Players" asp-action="Details" asp-route-id="@match.Player1Id"
                               class="entity-link @(p1Win ? "text-success fw-bold" : "")"
                               onclick="event.stopPropagation();return true;">
                                @match.Player1?.ApplicationUser?.FirstName @match.Player1?.ApplicationUser?.LastName
                            </a>
                        </div>
                        <div>
                            <a asp-controller="Players" asp-action="Details" asp-route-id="@match.Player2Id"
                               class="entity-link @(p2Win ? "text-success fw-bold" : "")"
                               onclick="event.stopPropagation();return true;">
                                @match.Player2?.ApplicationUser?.FirstName @match.Player2?.ApplicationUser?.LastName
                            </a>
                        </div>
                        <div>
                            <strong>@match.Score1 : @match.Score2</strong>
                            @if (!match.IsApproved)
                            {
                                <small class="text-warning">(niezatw.)</small>
                            }
                        </div>
                    }
                </div>


            }
        </div>
    }
</div>
