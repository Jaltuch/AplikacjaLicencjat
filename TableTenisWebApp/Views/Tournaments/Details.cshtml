@model TableTenisWebApp.Models.Tournament
@using TableTenisWebApp.Models.ViewModels
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.ViewFeatures
@using Microsoft.AspNetCore.Mvc.Razor
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@{
    var currentUserId = UserManager.GetUserId(User);
    var isOwner = Model.CreatedById == currentUserId;
}



@if (TempData["Err"] is string err)
{
    <div class="alert alert-danger">@err</div>
}
@if (TempData["Msg"] is string msg)
{
    <div class="alert alert-success">@msg</div>
}

@{
    ViewData["Title"] = "Szczegóły turnieju";
    var standings = ViewBag.Standings as IList<TournamentStandingRow> ?? new List<TournamentStandingRow>();
}

<h2>@Model.Name</h2>
@{
    string statusText;
    string statusClass;

    if (Model.IsFinished)
    {
        statusText = "Zakończone";
        statusClass = "bg-danger";
    }
    else if (Model.HasStarted)
    {
        statusText = "Trwa";
        statusClass = "bg-warning text-dark";
    }
    else
    {
        statusText = "Otwarte";
        statusClass = "bg-success";
    }
}

<span class="badge @statusClass">@statusText</span>

<p>
    <strong>Data rozpoczęcia:</strong>
    @(Model.Start is not null ? Model.Start.Value.ToString("dd.MM.yyyy HH:mm") : "jeszcze nie rozpoczęto")<br />
    <strong>Data zakończenia:</strong>
    @(Model.End is not null ? Model.End.Value.ToString("dd.MM.yyyy HH:mm") : "jeszcze nie zakończono")
</p>

<p>
    <span class="badge bg-primary">Typ: @Model.Type</span>
</p>
<p><strong>Limit graczy:</strong> @(Model.MaxPlayers is int val ? val.ToString() : "brak")</p>



<!------------- ZWYCIĘZCA ------------>
@{
    var totalMatches = Model.Matches.Count(m => m.Player1Id != m.Player2Id);
    var approvedMatches = Model.Matches.Count(m => m.Player1Id != m.Player2Id && m.IsApproved);
    var playerCount = Model.Players.Count;
    var expectedMatches = playerCount * (playerCount - 1) / 2;
     
}

@if (Model.Type == CompetitionType.League && totalMatches == expectedMatches && totalMatches == approvedMatches)
{
    var winner = standings.FirstOrDefault();
    if (winner != null)
    {
        <div class="alert alert-success text-center fs-5 fw-bold">
            🏆 Zwycięzca ligi: @winner.Name 🏆
        </div>
    }
}

<!------------- RANKING ------------>
@if (standings.Any())
{
    <h4>Ranking</h4>
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Zawodnik</th>
                <th>M</th>
                <th>W</th>
                <th>P</th>
                <th>+ / – sety</th>
                <th>Punkty</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < standings.Count; i++)
            {
                var r = standings[i];
                var isFirst = i == 0;
                <tr class="@(isFirst ? "table-warning fw-bold" : "")">
                    <td>@(i + 1)</td>
                    <td>
                        <a asp-controller="Players" asp-action="Details" asp-route-id="@r.PlayerId"
                           class="entity-link">
                            @r.Name
                        </a>
                        @if (isFirst)
                        {
                            <span title="Lider" class="ms-1">🏆</span>
                        }
                    </td>
                    <td>@r.Played</td>
                    <td>@r.Won</td>
                    <td>@r.Lost</td>
                    <td>@(r.SetsPlus - r.SetsMinus)</td>
                    <td>@r.Points</td>
                </tr>
            }
        </tbody>
    </table>
}



<!------------- UCZESTNICY ------------>
<h4>Uczestnicy (@Model.Players.Count)</h4>
<ul>
    @foreach (var tp in Model.Players
    .Where(p => p.Player?.ApplicationUser != null)
    .OrderBy(p => p.Player.ApplicationUser.LastName)
    .ThenBy(p => p.Player!.ApplicationUser!.FirstName))
    {
        <li>
            <a asp-controller="Players" asp-action="Details" asp-route-id="@tp.PlayerId"
               class="entity-link">
                @tp.Player?.ApplicationUser?.FirstName @tp.Player?.ApplicationUser?.LastName
            </a>
        </li>

    }
</ul>
@if ((User.IsInRole("Organizer") || User.IsInRole("Admin"))
   && Model.HasStarted
   && !Model.Matches.Any())
{
    <form asp-action="Generate" asp-route-id="@Model.Id" method="post">
        <button type="submit" class="btn btn-primary">Generuj terminarz</button>
    </form>
}


<!------------- GENEROWANIE DRABINKI ------------>
@if ((User.IsInRole("Organizer") || User.IsInRole("Admin"))
 && Model.Matches.Any()
 && Model.Type == CompetitionType.Knockout)
{
    var lastRound = Model.Matches.Max(m => m.RoundNumber);
    var roundMatches = Model.Matches.Where(m => m.RoundNumber == lastRound).ToList();
    bool allFinished = roundMatches.All(m => m.IsApproved);
    bool isFinal = roundMatches.Count == 1;

    if (allFinished && !isFinal)
    {
        <form asp-action="GenerateNextRound" method="post">
            <input type="hidden" name="id" value="@Model.Id" />
            <button class="btn btn-info">▶ Wygeneruj kolejną rundę</button>
        </form>
    }
}
@if (Model.Type == CompetitionType.Knockout)
{
    <a asp-action="Bracket" asp-route-id="@Model.Id" class="btn btn-outline-primary">
        📈 Pokaż drabinkę
    </a>
}


<!------------- MECZE ------------>
<h4>Mecze</h4>

@foreach (var group in Model.Matches
  .OrderBy(m => m.RoundNumber)
  .ThenBy(m => m.DatePlayed)
  .GroupBy(m => m.RoundNumber))
{
    var matchCount = group.Count();
    var roundLabel = Model.Type == CompetitionType.League
        ? $"📅 Kolejka {group.Key}"
        : matchCount switch
        {
            1 => "🏆 Finał",
            2 => "🥈 Półfinał",
            4 => "🥉 Ćwierćfinał",
            8 => "1/8 finału",
            16 => "1/16 finału",
            32 => "1/32 finału",
            _ => $"🥊 Runda {group.Key}"
        };

    <h4 style="background: #f8f9fa; padding: 0.5rem 1rem; border-left: 5px solid #0d6efd; margin-top: 2rem; border-radius: 4px;">
        @roundLabel
    </h4>


    <table class="table table-sm table-striped">
        <thead>
            <tr>
                <th>Mecz</th>
                <th>Wynik</th>
                <th>Data</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in group)
            {
                <tr class="clickable-row" data-href="@Url.Action("Details", "Matches", new { id = m.Id })">
                    
                    <td>
                        @if (m.Player1Id == m.Player2Id)
                        {
                            <span>
                                <a asp-controller="Players" asp-action="Details" asp-route-id="@m.Player1Id"
                                class="entity-link">
                                @m.Player1?.ApplicationUser?.FirstName @m.Player1?.ApplicationUser?.LastName – <em>wolny los</em>
                                </a>
                            </span>
                        }
                        else
                        {
                            <span>
                                <a asp-controller="Players" asp-action="Details" asp-route-id="@m.Player1Id"
                                   class="entity-link">
                                    @m.Player1?.ApplicationUser?.FirstName @m.Player1?.ApplicationUser?.LastName
                                </a> –
                                <a asp-controller="Players" asp-action="Details" asp-route-id="@m.Player2Id"
                                   class="entity-link">
                                    @m.Player2?.ApplicationUser?.FirstName @m.Player2?.ApplicationUser?.LastName
                                </a>
                            </span>

                        }
                    </td>
                    <td>
                        @if (m.Player1Id == m.Player2Id)
                        {
                            <span><em>awans</em></span>
                        }
                        else
                        {
                            @if (m.Score1 + m.Score2 == 0)
                            {
                                <span><em>brak wyniku</em></span>
                            }
                            else
                            {
                                <span>@m.Score1 : @m.Score2</span>
                                @if (!m.IsApproved)
                                {
                                    <span class="badge bg-warning text-dark ms-2"> Oczekuje na zatwierdzenie</span>
                                }
                                else
                                {
                                    <span class="badge bg-success text-light ms-2"> Zatwierdzony</span>
                                }
                            }

                        }
                    </td>
                    <td>@(m.DatePlayed is null ? "-" : m.DatePlayed.Value.ToString("d"))</td>

                    <td>
                        @if (!m.IsApproved &&
                      (
                      User.IsInRole("Admin") ||
                      User.IsInRole("Organizer") ||
                      (Model.AllowPlayersEnterScores &&
                      User.IsInRole("Player") &&
                      (UserManager.GetUserId(User) == m.Player1?.ApplicationUserId ||
                      UserManager.GetUserId(User) == m.Player2?.ApplicationUserId))
                      ))
                        {
                            <a asp-controller="Matches" asp-action="EnterScore" asp-route-id="@m.Id"
                            class="btn btn-sm btn-outline-success">Wpisz wynik</a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@if (User.IsInRole("Player") && SignInManager.IsSignedIn(User) && Model.IsOpenForSignup)
{
    var userId = UserManager.GetUserId(User);
    var alreadyJoined = Model.Players.Any(p => p.Player?.ApplicationUserId == userId);

    if (!alreadyJoined)
    {
        <form asp-action="Signup" asp-controller="Tournaments" asp-route-id="@Model.Id" method="post">
            <button type="submit" class="btn btn-success">✍ Zapisz się do turnieju</button>
        </form>
    }
    else
    {
        <div class="alert alert-info w-50">
            ✅ Jesteś zapisany do tego turnieju.
        </div>
    }
}

@if (User.IsInRole("Player"))
{
    var userId = UserManager.GetUserId(User);
    var player = Model.Players.FirstOrDefault(p => p.Player.ApplicationUserId == userId);

    if (player != null && Model.IsOpenForSignup)
    {
        <form asp-action="Withdraw" asp-controller="Tournaments" asp-route-id="@Model.Id" method="post">
            <button type="submit" class="btn btn-outline-danger">Wypisz się z turnieju</button>
        </form>
    }
}












<!------------- AKCJE ADMINA/ORGANIZATORA ------------>
@if ((User.IsInRole("Admin") || (User.IsInRole("Organizer") && isOwner))&& !Model.HasStarted)
{
    <p>
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edytuj</a>
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Usuń</a>
    </p>
}
@if ((User.IsInRole("Organizer") && Model.CreatedById == UserManager.GetUserId(User)) || User.IsInRole("Admin"))
{
    if (!Model.HasStarted)
    {
        <form asp-action="StartTournament" method="post" class="d-inline">
            <input type="hidden" name="id" value="@Model.Id" />
            <button class="btn btn-outline-success">
                ▶ Rozpocznij rozgrywkę
            </button>
        </form>
    }
}




@if (User.IsInRole("Admin") ||
   (User.IsInRole("Organizer") && Model.CreatedById == currentUserId))
{
    <a asp-controller="Matches" asp-action="ReviewMatches" asp-route-tournamentId="@Model.Id" class="btn btn-outline-secondary">
        ✅ Zatwierdź wyniki
    </a>
}




<a asp-action="Index">↩︎ Lista turniejów</a>
